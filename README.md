# AirMonitoring

## 1. Быстрый старт

### 1.1 Установка и первоначальная настройка
1. Клонируйте репозиторий в домашнюю директорию:
```bash
cd ~
git clone https://???.??/
cd nsk-eco
```

2. Настройка параметров баз данных Celery и PostgreSQL
Заполнить файл .example.env
Переименовать в .env

3. Создание виртуальной рабочей среды
Для Windows
```bash
python -m venv env
env\Scripts\activate.bat
pip install -r requirements.txt
```
Для MacOS
```bash
python3 -m venv env
source env/bin/activate
pip3 install -r requirements.txt
```

### 1.2 Запуск (каждый пункт в отдельном терминале)
1. Запуск backend (только в virtual env)
```bash
cd backend
uvicorn app.main:app --reload
```
Доступ по ссылке 127.0.0.1:8000 (стандартно)

2. Запуск fronend
```bash
cd frontend
npm run dev
```
Доступ по ссылке localhost:5173 (стандартно)

3. Запуск динамического обновления станций (только в virtual env)
```bash
cd backend
celery -A app.core.celery_app.celery worker -B --loglevel=info -P solo
```

## 2. API
**Интерактивная документация:** [автосгененированная fastapi в формате swagger]

Доступна по адресу:

`http://127.0.0.1:8080/docs`

**Особенности:**

- Полное описание всех эндпоинтов
- Возможность тестирования запросов прямо в браузере

### 2.1 GET-запросы
1. GET /stations
**Назначение:** Получение списка всех доступных станций с их основными характеристиками.

**Пример запроса:**
```bash
curl http://127.0.0.1:8080/stations
```

**Пример ответа:**
```json
[
  {
    "id": 21,
    "type_st": 1,
    "battery_life": 100,
    "latitude": 55.055092785700786,
    "longitude": 82.97620465806989,
    "PM_2_5": 0.52,
    "PM_10": 0.16,
    "overTLV": 0
  },
]
```

2. GET /stations/{station_id}
**Назначение:** Получение данных конкретной станции

**Пример запроса:**
```bash
curl http://127.0.0.1:8080/stations/1
```

**Пример ответа:**
```json
{
  "id": 1,
  "type_st": 0,
  "battery_life": 63,
  "latitude": 55.112268039115186,
  "longitude": 83.1092471235398,
  "PM_2_5": 0.65,
  "PM_10": 5.31,
  "overTLV": 0
}
```

3. GET staions/plot/cluster
**Назначение:** Получение полигонов деление станций для формирования расписания по кластерам

**Пример запроса:**
```bash
curl http://127.0.0.1:8000/stations/plot/cluster?capacity=10&mode=cluster_head
```

**Пример ответа:**
```json
{
  "polygons": [
    {
      "cluster_id": 0,
      "points": [
        [
          55.159949225596854,
          83.13900317171534
        ],
        [
          55.15944922559686,
          83.13850317171534
        ],
```

4. GET stations/plot/timezone
**Назначение:** Получение полигонов деление станций для формирования расписания по географическому положению

**Пример запроса:**
```bash
curl http://127.0.0.1:8000/stations/plot/timezone?capacity=10
```

**Пример ответа:**
```json
{
  "zones": [
    {
      "x_min": 54.80794922559686,
      "x_max": 54.83140223112628,
      "y_min": 82.86250317171535,
      "y_max": 83.22164222008364
    },
    {
      "x_min": 54.83140223112628,
      "x_max": 54.8548552366557,
      "y_min": 82.86250317171535,
      "y_max": 83.22164222008364
    },
```
5. GET stations/plot/{option}
**Назначение:** Получение графика деления станций на группы 

**Пример запроса:**
```bash
curl http://127.0.0.1:8000/stations/plot/1
```

**Пример ответа:**
Изображение с графиком и легендой

### 2.2 POST-запросы
1. POST stations/reset
**Назначение:** Сброс станций к исходному типу (используется при изменении типа расписания)

**Пример запроса:**
```bash
curl http://127.0.0.1:8000/stations/reset
```

2. POST stations/fake_pollutions
**Назначение:** Создать искуственное загрязнение

**Пример запроса:**
```bash
curl http://127.0.0.1:8000/stations/fake_pollutions
```

3. POST stations/clear_fake_pollutions
**Назначение:** Убрать искуственное загрязнение

**Пример запроса:**
```bash
curl http://127.0.0.1:8000/stations/clear_fake_pollutions
```

### 2.3 Коды ответов сервера

| Код | Статус               | Описание                  | Типичные сценарии                                                            |
|-----|----------------------|---------------------------|------------------------------------------------------------------------------|
| 200 | OK                   | Успешный запрос           | Данные успешно получены и возвращены в теле ответа                           |
| 204 | No Content           | Нет содержимого           | Запрос выполнен успешно, но данных за указанный период не найдено            |
| 400 | Bad Request          | Неверный запрос           | Ошибка валидации параметров (неверный формат времени, некорректные значения) |
| 404 | Not Found            | Не найдено                | Запрошенная станция или канал не существует                                  |
| 500 | Internal Server Error| Внутренняя ошибка сервера | Непредвиденная ошибка при обработке запроса                                  |
| 503 | Service Unavailable  | Сервис недоступен         | Нет доступа к хранилищу данных или временные проблемы с подключением         |
